<!doctype html>
<html class="docs-version-0.67" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="search" type="application/opensearchdescription+xml" title="React Native 中文网" href="/opensearch.xml">
<script src="//snack.expo.dev/embed.js" defer="defer"></script>
<script src="//cdn.wwads.cn/js/makemoney.js" defer="defer"></script><title data-react-helmet="true">Android 原生模块 · React Native 中文网</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="twitter:image" content="https://reactnative.cn/img/logo-og.png"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="0.67"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-0.67"><meta data-react-helmet="true" property="og:url" content="https://reactnative.cn"><meta data-react-helmet="true" property="og:image" content="img/logo-og.png"><meta data-react-helmet="true" property="og:title" content="Android 原生模块 · React Native 中文网"><meta data-react-helmet="true" name="description" content="有时候 App 需要访问平台 API，但 React Native 可能还没有相应的模块包装；或者你需要复用一些 Java 代码，而不是用 Javascript 重新实现一遍；又或者你需要实现某些高性能的、多线程的代码，譬如图片处理、数据库、或者各种高级扩展等等。"><meta data-react-helmet="true" property="og:description" content="有时候 App 需要访问平台 API，但 React Native 可能还没有相应的模块包装；或者你需要复用一些 Java 代码，而不是用 Javascript 重新实现一遍；又或者你需要实现某些高性能的、多线程的代码，譬如图片处理、数据库、或者各种高级扩展等等。"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://reactnative.cn/docs/native-modules-android"><link data-react-helmet="true" rel="alternate" href="https://reactnative.cn/docs/native-modules-android" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://reactnative.cn/docs/native-modules-android" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.cbfb91cb.css">
<link rel="preload" href="/assets/js/runtime~main.74683e8c.js" as="script">
<link rel="preload" href="/assets/js/main.5540c489.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_3wvD">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/header_logo.svg" alt="React Native 中文网" class="themedImage_Ir0T themedImage--light_2_E0"><img src="/img/header_logo.svg" alt="React Native 中文网" class="themedImage_Ir0T themedImage--dark_2JiM"></div><b class="navbar__title">React Native 中文网</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/docs/getting-started">0.67</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/native-modules-android">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/native-modules-android">0.67</a></li><li><a class="dropdown__link" href="/docs/0.66/native-modules-android">0.66</a></li><li><a class="dropdown__link" href="/docs/0.65/native-modules-android">0.65</a></li><li><a class="dropdown__link" href="/docs/0.64/native-modules-android">0.64</a></li><li><a class="dropdown__link" href="/docs/0.63/native-modules-android">0.63</a></li><li><a class="dropdown__link" href="/versions">所有版本</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/docs/getting-started">文档</a><a class="navbar__item navbar__link" href="/docs/components-and-apis">组件</a><a class="navbar__item navbar__link" href="/docs/accessibilityinfo">API</a><a class="navbar__item navbar__link" href="/docs/architecture-overview">架构</a><a href="//time.geekbang.org/column/intro/100110101?code=FAqHFVRUur%2FgAP-yJQWitk9ieF80imRky3PVsIs%2FX6A%3D" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link hot-link"><span>实战课<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pqex"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="//github.com/reactnativecn/react-native-website/issues" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>讨论<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pqex"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="//pushy.reactnative.cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link hot-link"><span>热更新<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pqex"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a class="navbar__item navbar__link" href="/about">关于</a><a href="//github.com/facebook/react-native" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-github-link" aria-label="GitHub repository"></a><div class="toggle_2wFP toggle_2vag toggleDisabled_1jUP"><div class="toggleTrack_OYnE" role="button" tabindex="-1"><div class="toggleTrackCheck_3aVv"><span class="toggleIcon_1mQT">🌜</span></div><div class="toggleTrackX_oB48"><span class="toggleIcon_1mQT">🌞</span></div><div class="toggleTrackThumb_3qal"></div></div><input type="checkbox" class="toggleScreenReader_bg_d" aria-label="Switch between dark and light mode"></div><div class="searchBox_WYtD"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_3jyA"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_2PbN" type="button"></button><aside class="docSidebarContainer_3jRz"><div class="sidebar_2j-V"><nav class="menu thin-scrollbar menu_1Xkn"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/getting-started">入门基础</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/environment-setup">环境搭建</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/running-on-device">开发流程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/style">设计</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/performance">性能调优</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/javascript-environment">JavaScript 运行环境</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_3-UD" href="/docs/native-modules-intro">原生模块</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/native-modules-intro">原生模块简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/native-modules-android">Android 原生模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/native-modules-ios">iOS 原生模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/native-modules-setup">原生模块配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/native-components-android">原生 UI 组件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_3-UD" href="/docs/headless-js-android">Android 与 iOS 指南</a></div></li></ul></nav></div></aside><main class="docMainContainer_28SP"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_2rXS"><div class="docItemContainer_1EXp"><article><a href="https://time.geekbang.org/column/intro/100110101?code=FAqHFVRUur%2FgAP-yJQWitk9ieF80imRky3PVsIs%2FX6A%3D" target="_blank" style="display:block;padding:12px;background-color:#eee;color:#666;margin-bottom:15px"><span style="font-weight:bold;color:#05a5d1">新架构实战课</span> <!-- -->实操 + 基建 + 原理全维度包揽，抢先掌握 React Native 新架构精髓<!-- --> <span style="border:solid 1px #666;padding:4px 6px;margin-left:8px;vertical-align:middle">立即查看 &gt;</span></a><div class="markdown"><header><h1>Android 原生模块</h1></header><p>有时候 App 需要访问平台 API，但 React Native 可能还没有相应的模块包装；或者你需要复用一些 Java 代码，而不是用 Javascript 重新实现一遍；又或者你需要实现某些高性能的、多线程的代码，譬如图片处理、数据库、或者各种高级扩展等等。</p><p>我们把 React Native 设计为可以在其基础上编写真正的原生代码，并且可以访问平台所有的能力。这是一个相对高级的特性，我们并不认为它应当在日常开发的过程中经常出现，但具备这样的能力是很重要的。如果 React Native 还不支持某个你需要的原生特性，你应当可以自己实现该特性的封装。</p><h2 class="anchor anchorWithStickyNavbar_23Bc" id="native-module-setup">Native Module Setup<a class="hash-link" href="#native-module-setup" title="Direct link to heading">​</a></h2><p>Native modules are usually distributed as npm packages, apart from the typical javascript files and resources they will contain an Android library project. This project is, from NPM&#x27;s perspective just like any other media asset, meaning there isn&#x27;t anything special about it from this point of view. To get the basic scaffolding make sure to read <a href="/docs/native-modules-setup">Native Modules Setup</a> guide first.</p><h3 class="anchor anchorWithStickyNavbar_23Bc" id="开启-gradle-daemon">开启 Gradle Daemon<a class="hash-link" href="#开启-gradle-daemon" title="Direct link to heading">​</a></h3><p>我们建议开启<a href="https://docs.gradle.org/2.9/userguide/gradle_daemon.html" target="_blank" rel="noopener noreferrer">Gradle Daemon</a>来加速 Java 代码编译。</p><h2 class="anchor anchorWithStickyNavbar_23Bc" id="toast-模块">Toast 模块<a class="hash-link" href="#toast-模块" title="Direct link to heading">​</a></h2><p>本向导会用<a href="http://developer.android.com/reference/android/widget/Toast.html" target="_blank" rel="noopener noreferrer">Toast</a>作为例子。假设我们希望可以从 Javascript 发起一个 Toast 消息（一种会在屏幕下方弹出、保持一段时间的消息通知）。</p><p>我们首先来创建一个原生模块。一个原生模块是一个继承了<code>ReactContextBaseJavaModule</code>的 Java 类，它可以实现一些 JavaScript 所需的功能。我们这里的目标是可以在 JavaScript 里写<code>ToastExample.show(&#x27;Awesome&#x27;, ToastExample.SHORT);</code>，来调起一个短暂的 Toast 通知。</p><p>创建一个新的 Java 类并命名为<code>ToastModule.java</code>，放置到<code>android/app/src/main/java/com/your-app-name/</code>目录下，其具体代码如下：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">// ToastModule.java</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">package com.your-app-name;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import android.widget.Toast;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.NativeModule;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.ReactApplicationContext;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.ReactContext;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.ReactContextBaseJavaModule;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.ReactMethod;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public class ToastModule extends ReactContextBaseJavaModule {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static ReactApplicationContext reactContext;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String DURATION_SHORT_KEY = &quot;SHORT&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String DURATION_LONG_KEY = &quot;LONG&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public ToastModule(ReactApplicationContext context) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    super(context);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    reactContext = context;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p><code>ReactContextBaseJavaModule</code>要求派生类实现<code>getName</code>方法。这个函数用于返回一个字符串名字，这个名字在 JavaScript 端标记这个模块。这里我们把这个模块叫做<code>ToastExample</code>，这样就可以在 JavaScript 中通过<code>NativeModules.ToastExample</code>访问到这个模块。<strong>译注：RN 已经内置了一个名为 ToastAndroid 的模块，所以在练习时请勿使用 ToastAndroid 的名字，否则运行时会报错名字冲突！</strong></p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public String getName() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    return &quot;ToastExample&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>一个可选的方法<code>getContants</code>返回了需要导出给 JavaScript 使用的常量。它并不一定需要实现，但在定义一些可以被 JavaScript 同步访问到的预定义的值时非常有用。</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public Map&lt;String, Object&gt; getConstants() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    final Map&lt;String, Object&gt; constants = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    constants.put(DURATION_SHORT_KEY, Toast.LENGTH_SHORT);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    constants.put(DURATION_LONG_KEY, Toast.LENGTH_LONG);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    return constants;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>要导出一个方法给 JavaScript 使用，Java 方法需要使用注解<code>@ReactMethod</code>。方法的返回类型必须为<code>void</code>。React Native 的跨语言访问是异步进行的，所以想要给 JavaScript 返回一个值的唯一办法是使用回调函数或者发送事件（参见下文的描述）。</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @ReactMethod</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public void show(String message, int duration) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    Toast.makeText(getReactApplicationContext(), message, duration).show();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_23Bc" id="参数类型">参数类型<a class="hash-link" href="#参数类型" title="Direct link to heading">​</a></h3><p>下面的参数类型在<code>@ReactMethod</code>注明的方法中，会被直接映射到它们对应的 JavaScript 类型。</p><div class="codeBlockContainer_1ukp language-text theme-code-block"><div class="codeBlockContent_3Y8q text"><pre tabindex="0" class="prism-code language-text codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">Boolean -&gt; Bool</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">Integer -&gt; Number</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">Double -&gt; Number</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">Float -&gt; Number</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">String -&gt; String</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">Callback -&gt; function</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">ReadableMap -&gt; Object</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">ReadableArray -&gt; Array</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>参阅<a href="https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/ReadableMap.java" target="_blank" rel="noopener noreferrer">ReadableMap</a>和<a href="https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/ReadableArray.java" target="_blank" rel="noopener noreferrer">ReadableArray</a>。</p><h3 class="anchor anchorWithStickyNavbar_23Bc" id="注册模块">注册模块<a class="hash-link" href="#注册模块" title="Direct link to heading">​</a></h3><p>在 Java 这边要做的最后一件事就是注册这个模块。我们需要在应用的 Package 类的<code>createNativeModules</code>方法中添加这个模块。如果模块没有被注册，它也无法在 JavaScript 中被访问到。</p><p>创建一个新的 Java 类并命名为<code>CustomToastPackage.java</code>，放置到<code>android/app/src/main/java/com/your-app-name/</code>目录下，其具体代码如下：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">// CustomToastPackage.java</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">package com.your-app-name;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.ReactPackage;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.NativeModule;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.ReactApplicationContext;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.uimanager.ViewManager;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import java.util.Collections;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public class CustomToastPackage implements ReactPackage {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public List&lt;ViewManager&gt; createViewManagers(ReactApplicationContext reactContext) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    return Collections.emptyList();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public List&lt;NativeModule&gt; createNativeModules(</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">                              ReactApplicationContext reactContext) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    List&lt;NativeModule&gt; modules = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    modules.add(new ToastModule(reactContext));</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    return modules;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>这个 package 需要在<code>MainApplication.java</code>文件的<code>getPackages</code>方法中提供。这个文件位于你的 react-native 应用文件夹的 android 目录中。具体路径是: <code>android/app/src/main/java/com/your-app-name/MainApplication.java</code>.</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">// MainApplication.java</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.your-app-name.CustomToastPackage; // &lt;-- 引入你自己的包</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">protected List&lt;ReactPackage&gt; getPackages() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @SuppressWarnings(&quot;UnnecessaryLocalVariable&quot;)</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  List&lt;ReactPackage&gt; packages = new PackageList(this).getPackages();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  // Packages that cannot be autolinked yet can be added manually here, for example:</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  // packages.add(new MyReactNativePackage());</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  packages.add(new CustomToastPackage()); // &lt;-- 添加这一行，类名替换成你的Package类的名字 name.</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  return packages;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>为了让你的功能从 JavaScript 端访问起来更为方便，通常我们都会把原生模块封装成一个 JavaScript 模块。这不是必须的，但省下了每次都从<code>NativeModules</code>中获取对应模块的步骤。这个 JS 文件也可以用于添加一些其他 JavaScript 端实现的功能。</p><div class="codeBlockContainer_1ukp language-jsx theme-code-block"><div class="codeBlockContent_3Y8q jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1">// ToastExample.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">/**</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> * This exposes the native ToastExample module as a JS module. This has a</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> * function &#x27;show&#x27; which takes the following parameters:</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> *</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> * 1. String message: A string with the text to toast</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> * 2. int duration: The duration of the toast. May be ToastExample.SHORT or</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> *    ToastExample.LONG</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token comment" style="color:#93a1a1"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"> NativeModules </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">from</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;react-native&#x27;</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">// 下一句中的ToastExample即对应上文</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">// public String getName()中返回的字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">export</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">default</span><span class="token plain"> NativeModules</span><span class="token punctuation" style="color:#657b83">.</span><span class="token plain">ToastExample</span><span class="token punctuation" style="color:#657b83">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>现在，在别处的 JavaScript 代码中可以这样调用你的方法：</p><div class="codeBlockContainer_1ukp language-jsx theme-code-block"><div class="codeBlockContent_3Y8q jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> ToastExample </span><span class="token keyword" style="color:#c5a5c5">from</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;./ToastExample&#x27;</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">ToastExample</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">show</span><span class="token punctuation" style="color:#657b83">(</span><span class="token string" style="color:#8dc891">&#x27;Awesome&#x27;</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"> ToastExample</span><span class="token punctuation" style="color:#657b83">.</span><span class="token constant" style="color:#5a9bcf">SHORT</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_23Bc" id="更多特性">更多特性<a class="hash-link" href="#更多特性" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_23Bc" id="回调函数">回调函数<a class="hash-link" href="#回调函数" title="Direct link to heading">​</a></h3><p>原生模块还支持一种特殊的参数——回调函数。它提供了一个函数来把返回值传回给 JavaScript。</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.Callback;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public class UIManagerModule extends ReactContextBaseJavaModule {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @ReactMethod</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public void measureLayout(</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      int tag,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      int ancestorTag,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      Callback errorCallback,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      Callback successCallback) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      measureLayout(tag, ancestorTag, mMeasureBuffer);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      float relativeX = PixelUtil.toDIPFromPixel(mMeasureBuffer[0]);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      float relativeY = PixelUtil.toDIPFromPixel(mMeasureBuffer[1]);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      float width = PixelUtil.toDIPFromPixel(mMeasureBuffer[2]);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      float height = PixelUtil.toDIPFromPixel(mMeasureBuffer[3]);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      successCallback.invoke(relativeX, relativeY, width, height);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    } catch (IllegalViewOperationException e) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      errorCallback.invoke(e.getMessage());</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>这个函数可以在 JavaScript 里这样使用：</p><div class="codeBlockContainer_1ukp language-jsx theme-code-block"><div class="codeBlockContent_3Y8q jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">UIManager</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">measureLayout</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">100</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token number" style="color:#5a9bcf">100</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">(</span><span class="token parameter">msg</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    console</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">log</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">}</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">(</span><span class="token parameter">x</span><span class="token parameter punctuation" style="color:#657b83">,</span><span class="token parameter"> y</span><span class="token parameter punctuation" style="color:#657b83">,</span><span class="token parameter"> width</span><span class="token parameter punctuation" style="color:#657b83">,</span><span class="token parameter"> height</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    console</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">log</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">x </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> y </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> width </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> height</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>原生模块通常只应调用回调函数一次。但是，它可以保存 callback 并在将来调用。</p><p>请务必注意 callback 并非在对应的原生函数返回后立即被执行——注意跨语言通讯是异步的，这个执行过程会通过消息循环来进行。</p><h3 class="anchor anchorWithStickyNavbar_23Bc" id="promises">Promises<a class="hash-link" href="#promises" title="Direct link to heading">​</a></h3><p>Promises</p><p><strong>译注</strong>：这一部分涉及到较新的 js 语法和特性，不熟悉的读者建议先阅读 ES6 的相关书籍和文档。</p><p>原生模块还可以使用 promise 来简化代码，搭配 ES2016(ES7)标准的<code>async/await</code>语法则效果更佳。如果桥接原生方法的最后一个参数是一个<code>Promise</code>，则对应的 JS 方法就会返回一个 Promise 对象。</p><p>我们把上面的代码用 promise 来代替回调进行重构：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.Promise;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public class UIManagerModule extends ReactContextBaseJavaModule {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String E_LAYOUT_ERROR = &quot;E_LAYOUT_ERROR&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @ReactMethod</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public void measureLayout(</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      int tag,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      int ancestorTag,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      Promise promise) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      measureLayout(tag, ancestorTag, mMeasureBuffer);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      WritableMap map = Arguments.createMap();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      map.putDouble(&quot;relativeX&quot;, PixelUtil.toDIPFromPixel(mMeasureBuffer[0]));</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      map.putDouble(&quot;relativeY&quot;, PixelUtil.toDIPFromPixel(mMeasureBuffer[1]));</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      map.putDouble(&quot;width&quot;, PixelUtil.toDIPFromPixel(mMeasureBuffer[2]));</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      map.putDouble(&quot;height&quot;, PixelUtil.toDIPFromPixel(mMeasureBuffer[3]));</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      promise.resolve(map);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    } catch (IllegalViewOperationException e) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      promise.reject(E_LAYOUT_ERROR, e);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>现在 JavaScript 端的方法会返回一个 Promise。这样你就可以在一个声明了<code>async</code>的异步函数内使用<code>await</code>关键字来调用，并等待其结果返回。（虽然这样写着看起来像同步操作，但实际仍然是异步的，并不会阻塞执行来等待）。</p><div class="codeBlockContainer_1ukp language-jsx theme-code-block"><div class="codeBlockContent_3Y8q jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token keyword" style="color:#c5a5c5">async</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">measureLayout</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      relativeX</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      relativeY</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      width</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      height</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">await</span><span class="token plain"> UIManager</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">measureLayout</span><span class="token punctuation" style="color:#657b83">(</span><span class="token number" style="color:#5a9bcf">100</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">100</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    console</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">log</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      relativeX </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> relativeY </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> width </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">+</span><span class="token plain"> height</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    console</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">error</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token function" style="color:#79b6f2">measureLayout</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_23Bc" id="多线程">多线程<a class="hash-link" href="#多线程" title="Direct link to heading">​</a></h3><p>原生模块不应对自己被调用时所处的线程做任何假设，当前的状况有可能会在将来的版本中改变。如果一个过程要阻塞执行一段时间，这个工作应当分配到一个内部管理的工作线程，然后从那边可以调用任意的回调函数。<em>译注</em>：我们通常用 AsyncTask 来完成这项工作。</p><h3 class="anchor anchorWithStickyNavbar_23Bc" id="发送事件到-javascript">发送事件到 JavaScript<a class="hash-link" href="#发送事件到-javascript" title="Direct link to heading">​</a></h3><p>原生模块可以在没有被调用的情况下往 JavaScript 发送事件通知。最简单的办法就是通过<code>RCTDeviceEventEmitter</code>，这可以通过<code>ReactContext</code>来获得对应的引用，像这样：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.modules.core.DeviceEventManagerModule;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.WritableMap;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">import com.facebook.react.bridge.Arguments;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">private void sendEvent(ReactContext reactContext,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">                       String eventName,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">                       @Nullable WritableMap params) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  reactContext</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class)</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      .emit(eventName, params);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">@ReactMethod</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public void addListener(String eventName) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  // Set up any upstream listeners or background tasks as necessary</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">@ReactMethod</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public void removeListeners(Integer count) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  // Remove upstream listeners, stop unnecessary background tasks</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">WritableMap params = Arguments.createMap();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">params.putString(&quot;eventProperty&quot;, &quot;someValue&quot;);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">sendEvent(reactContext, &quot;EventReminder&quot;, params);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>JavaScript 模块可以通过使用<code>NativeEventEmitter</code>模块来监听事件：</p><div class="codeBlockContainer_1ukp language-jsx theme-code-block"><div class="codeBlockContent_3Y8q jsx"><pre tabindex="0" class="prism-code language-jsx codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"> NativeEventEmitter</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"> NativeModules </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">from</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&#x27;react-native&#x27;</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token function" style="color:#79b6f2">componentDidMount</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">const</span><span class="token plain"> eventEmitter </span><span class="token operator" style="color:#fc929e">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name" style="color:#fac863">NativeEventEmitter</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">NativeModules</span><span class="token punctuation" style="color:#657b83">.</span><span class="token plain">ToastExample</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">this</span><span class="token punctuation" style="color:#657b83">.</span><span class="token plain">eventListener </span><span class="token operator" style="color:#fc929e">=</span><span class="token plain"> eventEmitter</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">addListener</span><span class="token punctuation" style="color:#657b83">(</span><span class="token string" style="color:#8dc891">&#x27;EventReminder&#x27;</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token operator" style="color:#fc929e">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">       console</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">log</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#657b83">.</span><span class="token plain">eventProperty</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token comment" style="color:#93a1a1">// &quot;someValue&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token punctuation" style="color:#657b83">}</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token function" style="color:#79b6f2">componentWillUnmount</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">this</span><span class="token punctuation" style="color:#657b83">.</span><span class="token plain">eventListener</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">remove</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"> </span><span class="token comment" style="color:#93a1a1">// 组件卸载时记得移除监听事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_23Bc" id="从startactivityforresult中获取结果">从<code>startActivityForResult</code>中获取结果<a class="hash-link" href="#从startactivityforresult中获取结果" title="Direct link to heading">​</a></h3><p>如果你使用<code>startActivityForResult</code>调起了一个 activity 并想从其中获取返回结果，那么你需要监听<code>onActivityResult</code>事件。具体的做法是继承<code>BaseActivityEventListener</code>或是实现<code>ActivityEventListener</code>。我们推荐前一种做法，因为它相对来说不太会受到 API 变更的影响。然后你需要在模块的构造函数中注册这一监听事件。</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">reactContext.addActivityEventListener(mActivityResultListener);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>现在你可以通过重写下面的方法来实现对<code>onActivityResult</code>的监听：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public void onActivityResult(</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  final Activity activity,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  final int requestCode,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  final int resultCode,</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  final Intent intent) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  // 在这里实现你自己的逻辑</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>下面我们写一个简单的图片选择器来实践一下。这个图片选择器会把<code>pickImage</code>方法暴露给 JavaScript，而这个方法在调用时就会把图片的路径返回到 JS 端。</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public class ImagePickerModule extends ReactContextBaseJavaModule {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final int IMAGE_PICKER_REQUEST = 467081;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String E_ACTIVITY_DOES_NOT_EXIST = &quot;E_ACTIVITY_DOES_NOT_EXIST&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String E_PICKER_CANCELLED = &quot;E_PICKER_CANCELLED&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String E_FAILED_TO_SHOW_PICKER = &quot;E_FAILED_TO_SHOW_PICKER&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private static final String E_NO_IMAGE_DATA_FOUND = &quot;E_NO_IMAGE_DATA_FOUND&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private Promise mPickerPromise;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  private final ActivityEventListener mActivityEventListener = new BaseActivityEventListener() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    public void onActivityResult(Activity activity, int requestCode, int resultCode, Intent intent) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      if (requestCode == IMAGE_PICKER_REQUEST) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">        if (mPickerPromise != null) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">          if (resultCode == Activity.RESULT_CANCELED) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">            mPickerPromise.reject(E_PICKER_CANCELLED, &quot;Image picker was cancelled&quot;);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">          } else if (resultCode == Activity.RESULT_OK) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">            Uri uri = intent.getData();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">            if (uri == null) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">              mPickerPromise.reject(E_NO_IMAGE_DATA_FOUND, &quot;No image data found&quot;);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">              mPickerPromise.resolve(uri.toString());</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">          mPickerPromise = null;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  };</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  ImagePickerModule(ReactApplicationContext reactContext) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    super(reactContext);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    // Add the listener for `onActivityResult`</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    reactContext.addActivityEventListener(mActivityEventListener);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public String getName() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    return &quot;ImagePickerModule&quot;;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  @ReactMethod</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  public void pickImage(final Promise promise) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    Activity currentActivity = getCurrentActivity();</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    if (currentActivity == null) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      promise.reject(E_ACTIVITY_DOES_NOT_EXIST, &quot;Activity doesn&#x27;t exist&quot;);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      return;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    // Store the promise to resolve/reject when picker returns data</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    mPickerPromise = promise;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      final Intent galleryIntent = new Intent(Intent.ACTION_PICK);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      galleryIntent.setType(&quot;image/*&quot;);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      final Intent chooserIntent = Intent.createChooser(galleryIntent, &quot;Pick an image&quot;);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      currentActivity.startActivityForResult(chooserIntent, IMAGE_PICKER_REQUEST);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      mPickerPromise.reject(E_FAILED_TO_SHOW_PICKER, e);</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">      mPickerPromise = null;</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_23Bc" id="监听生命周期事件">监听生命周期事件<a class="hash-link" href="#监听生命周期事件" title="Direct link to heading">​</a></h3><p>监听 activity 的生命周期事件（比如<code>onResume</code>, <code>onPause</code>等等）和我们在前面实现 <code>ActivityEventListener</code>的做法类似。模块必须实现<code>LifecycleEventListener</code>，然后需要在构造函数中注册一个监听函数：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">reactContext.addLifecycleEventListener(this);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div><p>现在你可以通过实现下列方法来监听 activity 的生命周期事件了：</p><div class="codeBlockContainer_1ukp language-java theme-code-block"><div class="codeBlockContent_3Y8q java"><pre tabindex="0" class="prism-code language-java codeBlock_2Xgr thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_3Zfi"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public void onHostResume() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    // Activity `onResume`</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public void onHostPause() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    // Activity `onPause`</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">public void onHostDestroy() {</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    // Activity `onDestroy`</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1mju clean-btn">Copy</button></div></div></div><footer class="docMetadata row docusaurus-mt-lg"><div class="col"><a href="https://github.com/reactnativecn/react-native-website/blob/production/cnwebsite/../cndocs/native-modules-android.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_1CBY" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_1szQ"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_rbnR thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#native-module-setup" class="table-of-contents__link toc-highlight">Native Module Setup</a><ul><li><a href="#开启-gradle-daemon" class="table-of-contents__link toc-highlight">开启 Gradle Daemon</a></li></ul></li><li><a href="#toast-模块" class="table-of-contents__link toc-highlight">Toast 模块</a><ul><li><a href="#参数类型" class="table-of-contents__link toc-highlight">参数类型</a></li><li><a href="#注册模块" class="table-of-contents__link toc-highlight">注册模块</a></li></ul></li><li><a href="#更多特性" class="table-of-contents__link toc-highlight">更多特性</a><ul><li><a href="#回调函数" class="table-of-contents__link toc-highlight">回调函数</a></li><li><a href="#promises" class="table-of-contents__link toc-highlight">Promises</a></li><li><a href="#多线程" class="table-of-contents__link toc-highlight">多线程</a></li><li><a href="#发送事件到-javascript" class="table-of-contents__link toc-highlight">发送事件到 JavaScript</a></li><li><a href="#从startactivityforresult中获取结果" class="table-of-contents__link toc-highlight">从<code>startActivityForResult</code>中获取结果</a></li><li><a href="#监听生命周期事件" class="table-of-contents__link toc-highlight">监听生命周期事件</a></li></ul></li></ul><div class="wwads-cn wwads-vertical" data-id="58" style="max-width:200px;margin-top:20px"></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">React Native 中文网 © 2022 武汉青罗网络科技有限公司
      <a style="margin-left:10px" href="http://beian.miit.gov.cn/">鄂ICP备20002031号-3</a>
      <img style="width:25px" src="//img.alicdn.com/tfs/TB1..50QpXXXXX7XpXXXXXXXXXX-40-40.png" alt="鄂公网安备 42011202001821号">
      <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011202001821">鄂公网安备 42011202001821号</a>
      </div></div></div></footer></div>
<script src="/assets/js/runtime~main.74683e8c.js"></script>
<script src="/assets/js/main.5540c489.js"></script>
</body>
</html>